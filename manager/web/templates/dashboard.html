{% extends "base.html" %}

{% block title %}Dashboard - OrbitVPN Manager{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="initDashboard()">
    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">âš¡</div>
            <div class="stat-content">
                <div class="stat-label">Running Services</div>
                <div class="stat-value" x-text="`${systemStatus.running_services}/${systemStatus.total_services}`">-</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">ðŸ‘¥</div>
            <div class="stat-content">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" x-text="userStats.total_users">-</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
                <div class="stat-label">Active Subscriptions</div>
                <div class="stat-value" x-text="userStats.active_subscriptions">-</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">ðŸ†•</div>
            <div class="stat-content">
                <div class="stat-label">New Today</div>
                <div class="stat-value" x-text="userStats.new_today">-</div>
            </div>
        </div>
    </div>

    <!-- Services Status -->
    <div class="card">
        <div class="card-header">
            <h3>Services</h3>
            <button @click="refreshServices()" class="btn btn-sm">Refresh</button>
        </div>
        <div class="card-body">
            <div class="services-grid">
                <template x-for="(service, name) in services" :key="name">
                    <div class="service-card" :class="getServiceStatusClass(service.status)">
                        <div class="service-header">
                            <h4 x-text="name"></h4>
                            <span class="service-status" x-text="service.status"></span>
                        </div>
                        <div class="service-stats">
                            <div class="stat">
                                <span class="label">Health:</span>
                                <span class="value" :class="getHealthClass(service.health.status)" x-text="service.health.status"></span>
                            </div>
                            <div class="stat">
                                <span class="label">CPU:</span>
                                <span class="value" x-text="`${service.metrics.cpu_percent.toFixed(1)}%`"></span>
                            </div>
                            <div class="stat">
                                <span class="label">Memory:</span>
                                <span class="value" x-text="`${service.metrics.memory_mb.toFixed(1)} MB`"></span>
                            </div>
                            <div class="stat">
                                <span class="label">Uptime:</span>
                                <span class="value" x-text="formatUptime(service.metrics.uptime_seconds)"></span>
                            </div>
                        </div>
                        <div class="service-actions">
                            <button @click="controlService(name, 'start')"
                                    class="btn btn-sm btn-success"
                                    :disabled="service.status === 'running'">Start</button>
                            <button @click="controlService(name, 'stop')"
                                    class="btn btn-sm btn-danger"
                                    :disabled="service.status === 'stopped'">Stop</button>
                            <button @click="controlService(name, 'restart')"
                                    class="btn btn-sm btn-warning"
                                    :disabled="service.status === 'stopped'">Restart</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Marzban Overview -->
    <div class="card">
        <div class="card-header">
            <h3>Marzban Infrastructure</h3>
            <a href="/marzban" class="btn btn-sm">View Details</a>
        </div>
        <div class="card-body">
            <div class="marzban-overview">
                <template x-for="instance in marzbanInstances" :key="instance.instance_id">
                    <div class="instance-card" :class="getHealthClass(instance.status)">
                        <div class="instance-header">
                            <h4 x-text="instance.name"></h4>
                            <span class="status-badge" :class="getHealthClass(instance.status)" x-text="instance.status"></span>
                        </div>
                        <div class="instance-stats">
                            <div class="stat">
                                <span>Total Users:</span>
                                <strong x-text="instance.total_users"></strong>
                            </div>
                            <div class="stat">
                                <span>Active Users:</span>
                                <strong x-text="instance.active_users"></strong>
                            </div>
                            <div class="stat">
                                <span>Nodes:</span>
                                <strong x-text="instance.nodes.length"></strong>
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="marzbanInstances.length === 0" class="empty-state">
                    <p>No Marzban instances configured</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Chart -->
    <div class="card">
        <div class="card-header">
            <h3>System Metrics</h3>
        </div>
        <div class="card-body">
            <canvas id="metricsChart" width="400" height="150"></canvas>
        </div>
    </div>
</div>

<script>
function dashboard() {
    return {
        systemStatus: {
            running_services: 0,
            total_services: 0,
            overall_health: 'unknown'
        },
        services: {},
        userStats: {
            total_users: 0,
            active_subscriptions: 0,
            trial_users: 0,
            new_today: 0,
            total_configs: 0
        },
        marzbanInstances: [],
        chart: null,

        async initDashboard() {
            await this.loadData();
            this.initChart();

            // Auto-refresh every 10 seconds
            setInterval(() => this.loadData(), 10000);
        },

        async loadData() {
            await Promise.all([
                this.loadSystemStatus(),
                this.loadServices(),
                this.loadUserStats(),
                this.loadMarzbanInstances()
            ]);
        },

        async loadSystemStatus() {
            const response = await fetch('/api/status');
            this.systemStatus = await response.json();
        },

        async loadServices() {
            const response = await fetch('/api/services');
            const data = await response.json();
            this.services = data.services;
        },

        async loadUserStats() {
            const response = await fetch('/api/users/stats');
            this.userStats = await response.json();
        },

        async loadMarzbanInstances() {
            const response = await fetch('/api/marzban/instances');
            const data = await response.json();
            this.marzbanInstances = data.instances;
        },

        async refreshServices() {
            await this.loadServices();
        },

        async controlService(name, action) {
            try {
                const response = await fetch(`/api/services/${name}/${action}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    setTimeout(() => this.loadServices(), 2000);
                } else {
                    alert(`Failed to ${action} ${name}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        },

        getServiceStatusClass(status) {
            const classes = {
                'running': 'status-running',
                'stopped': 'status-stopped',
                'failed': 'status-failed',
                'starting': 'status-starting',
                'stopping': 'status-stopping'
            };
            return classes[status] || '';
        },

        getHealthClass(health) {
            const classes = {
                'healthy': 'health-healthy',
                'degraded': 'health-degraded',
                'unhealthy': 'health-unhealthy',
                'unknown': 'health-unknown'
            };
            return classes[health] || 'health-unknown';
        },

        formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        },

        initChart() {
            const ctx = document.getElementById('metricsChart');
            this.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    }, {
                        label: 'Memory MB',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }
}
</script>
{% endblock %}
